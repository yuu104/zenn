---
title: "なぜ単体テストを行うのか？"
---

## 単体テストの現状

- 近年、単体テストはソフトウェア業界に広く浸透した
- 単体テストを導入することは当然の認識になった
- プロダクションコードとテストコードの割合は 1:1 ~1:3（場合によっては 1:10 になることも）
- 「単体テストを書くべきか？」から「良い単体テストを書くとはどういうことか？」へ
- 自動化されたテストをいくら用意しても、望ましい結果を得られるとは限らない
- リグレッションテストに失敗し、新たなバグが何度も出現することも多い
- プロジェクトの助けになることを目的に導入した単体テストが、返って悪化させることも良くある
- 「良い単体テスト」が書けるかどうかがプロジェクトの成功に大きく左右する
- よって、「良いテストとは何か？」を探求することは重要
- しかし、「良いテスト」について議論されることは少ない

## なぜ単体テストを行うのか？

### ソフトウェアの成長を持続可能なものにするため

単体テスト、というか自動テストの目的は「**ソフトウェアの成長を持続可能なものにするため**」です。

ソフトウェアというものは、簡単に肥大化します。
しかし、その成長を持続させることは簡単ではありません。

初期フェーズでは短い時間で素早く順調に成長していきます。
足枷となるもの（複雑化したコード、適さなくなったアーキテクチャ、etc.）が何もないためです。

しかし、時間の経過につれ、同じ成長をするために必要な労力が大きくなります。
これにより、当初あった開発スピードは失われ、最終的には何をしても成長できなくなる場合もあります。

![](https://storage.googleapis.com/zenn-user-upload/70d10ab58633-20241123.png =450x)
_ソフトウェアの成長曲線（自動テストがない場合）_

なぜ開発スピードが落ちるのでしょうか？
それは、**コードの劣化によるエントロピー（無秩序の量）が多くなるから**です。

コードに対して何らかの変更を加えることは、エントロピーを増やすことを意味します。
そして、無秩序な状態を放置しておくと、ソフトウェアはすぐさま複雑になります。
そうなると、次のような苦しい経験をする羽目になります。

- 簡単な機能追加・修正に時間がかかる
- 変更による影響範囲が特定できない
- 変更により、良くわからない新たなバグが生まれる
- 既存コードが理解できない
- 実装タスクを完遂させるまでの見積もりが困難になる

エンジニアであれば、一度は経験したことがあるのではないでしょうか？
「無秩序により開発スピードが落ちる」というのはこういうことです。

### 単体テストにより、無秩序から脱却する

エントロピー（無秩序の量）の増大により、成長の持続可能性が失われることを説明しました。
開発者を苦しめ、ソフトウェアの成長を著しく妨げる「無秩序」はどのように解消すれば良いのでしょうか？

この解決策として有効なものが、自動テストです。
そして、その手法の 1 つとして存在するのが単体テストなのです。

単体テストの導入により生まれる以下の恩恵が、無秩序の解消に繋がります。

1. **コードの信頼性をすぐに確認できる**
   コードに対して何かしらの変更を加えた際、その変更が既存のロジックに悪影響を及ぼしていないことを素早く確認できます。
   自動で実行される単体テストにより、コードの動作が期待通りであることがすぐに検証でき、変更が原因でエラーが発生していないかを早期に発見できます。
   この即時的なフィードバックが、無秩序の増大を防ぐ大きな力となります。
2. **リファクタリングしやすくなる**
   リファクタリングは、無秩序なコードを改善するための有効な手段です。
   しかし、銀の弾丸というわけではなく、相応のリスクもあります。これまで正常に動いていたコードを変更するので、返ってバグを生み出してしまう可能性があります。
   そのため、開発者がリファクタリングを行う際には、既存の動作が壊れないかという不安と戦うことになり、その不安がリファクタリングの機会を妨げてしまうのです。
   単体テストが整備されていれば、リファクタリング後の挙動をテストで確認できるため、開発者は躊躇なく既存コードを変更し、改善を進めることが可能になります。
3. **開発者が自分の書いたコードに対し、根拠ある自信を持つことができる**
   「コードの信頼性をすぐに確認できる」と「リファクタリングしやすくなる」は開発者に自信を与えることが出来ます。
   \
   まず、単体テストによる即時的なフィードバックが、開発者にとって大きな精神的な支えとなります。
   自分が加えた変更が既存の機能に影響を与えていないかを迅速に確認できるため、「間違っていたらすぐに教えてくれる」環境が整い、開発者は安心して新しい機能追加や変更を進めることができます。
   この安心感が、開発者に「自分のコードは期待通りに動作している」という根拠ある自信をもたらします。
   \
   また、この安心感はリファクタリングの促進に繋がります。
   改善の機会が増えれば無秩序なコードベースは次第に秩序あるものに変化し、それを維持し続けることが可能になります。
   これにより、開発者は「良いコードが書けている」という自信と、コードに対する誇りを持つことができます。

単体テストにより開発者が自信を持つことができる環境が整えば、より積極的にコードの改善や新規アイデアの導入に挑戦することができ、成長の加速へ繋がります。
このサイクルを維持することで持続可能なソフトウェアの成長が実現可能になります。

![](https://storage.googleapis.com/zenn-user-upload/c909bab5850b-20241123.png =450x)
_ソフトウェアの成長曲線（自動テストがある場合）_

### 単体テストの導入には労力がかかる

単体テストの欠点は、導入コストです。
特に、既存プロジェクトに対してテストを導入することは大きな労力が必要になるかもしれません。

初期フェーズではテストがない方が開発コスト削減でき、成長速度も勝るでしょう。

![](https://storage.googleapis.com/zenn-user-upload/89fc25add667-20241124.png)

\
ただ、中長期で見れば、優位性は逆転し、その差は圧倒的なものになります。
![](https://storage.googleapis.com/zenn-user-upload/c7b9727ba886-20241124.png =450x)

### 「より優れた設計に改善するため」ではない

単体テストを必ず書くようにすれば、設計はより優れたものになります。
しかし、単体テストによって到達したい第一目標ではありません。
単体テストにより設計が改善されることは、副産物にすぎません。

:::message
**単体テストと設計の関係**

「単体テストのしやすさ」から「プロダクションコードの質」を以下のように評価することができます。

![](https://storage.googleapis.com/zenn-user-upload/188d9f90bb2a-20241124.png =450x)

単体テストがしにくい理由は、コードが密結合になっているからです。
\
つまり、以下の関係性が成り立つのです。

![](https://storage.googleapis.com/zenn-user-upload/0f98ad2a338b-20241124.png)

\
一方、以下のように評価することはできません。

![](https://storage.googleapis.com/zenn-user-upload/7ec70cb16d4c-20241124.png =450x)

\
単体テストがしやすいということは、コードが疎結合になっていることを示唆します。
しかし、疎結合であれば、プロダクションコードの質が高く良い設計になっているとは限らないのです。

![](https://storage.googleapis.com/zenn-user-upload/a994abdcd20c-20241124.png)

:::

### 質の低いテストは意味がない

単体テストの導入がソフトウェアの成長維持に繋がるということお話しました。
しかし、ただ単に導入すれば良くなるというわけではありません。
作成されたテストの質が重要です。

テストの質が低い場合でも、初期フェーズではエントロピーの増加を遅らせることが可能です。
しかし、時間経過に伴い、開発コストはテストが存在しない場合と比較して大差ない状態となります。

そのため、長期的には「テストがないソフトウェア」と「質の低いテストがあるソフトウェア」の成長速度は変わりません。

![](https://storage.googleapis.com/zenn-user-upload/0a9517af61d8-20241124.png =450x)

質の低いテストは、ソフトウェアの成長速度を落とすのでしょうか？
それは、以下のような事象が発生し、「無秩序」を生み出してしまうからです。

- テストが間違った理由で失敗することが頻繁に発生する
- 変更による意図しないバグを検出できない
- テストの運用コストが増大する

:::message

**テストの運用コストとは？**
テストの導入にあたり、次のような様々な作業が必要になります。

- プロダクションコードのリファクタリングに伴い、テストコードをリファクタリングする
- プロダクションコードを変更するたびにテストを実施する
- テストが間違って失敗した際の対処
- プロダクションコードの振る舞いを理解するために、テストコードを読む

:::

では、なぜ質の低いテストが生まれるのでしょうか？
それは、**単体テストがどのようにプロジェクトの助けとなるかを理解できていない**からです。
単体テストによる恩恵を理解できてい場合、「単体テストを書く」こと自体が目的となってしまいがちです。

そのため、「ソフトウェアの成長を助けるテスト」だけを作成することに意識をむけましょう。
