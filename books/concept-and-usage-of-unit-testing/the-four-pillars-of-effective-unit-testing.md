---
title: "価値の高い単体テストを構成する4本の柱"
---

テストの質を良くする要素は以下の 3 つ。

- **開発サイクルの中でテストできる**
- **コードベースの重要な部分のみがテスト対象となっている**
- **最小限の保守コストで最大限の価値が生み出せている**

価値のあるテストケースを**認識する**ことと**作成する**ことは異なるスキルです。

この Chapter では、**価値のあるテストケースを認識するための基準**について解説します。

## 価値の高い単体テストを構成する 4 本の柱

1. **退行（regression）に対する保護**
2. **リファクタリングへの耐性**
3. **迅速なフィードバック**
4. **保守のしやすさ**

## ① 退行（regression）に対する保護

**退行（regression）** とは、変更を加えた後に、既存の機能が意図したように動かなくなるバグのことです。
例えば、新しい機能を追加したときに、それまで正常に動いていた別の機能が突然動かなくなる状況です。

### なぜ退行が問題なのか？

退行（regression）が最も深刻なのは、既存の機能の振る舞いが予期せず変わってしまうことです。
開発チームが新しい機能を開発するたびに既存機能が壊れるようでは、開発速度は著しく低下します。

重要なポイントとして、**コードは資産ではなく、負債**だということを理解しておく必要があります。
コードベースが大きくなればなるほど、より多くの潜在的なバグを抱えることになります。
だからこそ、退行（regression）から保護する仕組みを作り出すことが非常に重要なのです。
もし適切な保護が得られなければ、開発チームは絶え間ないバグ対応に時間を取られ、プロジェクトの成長を維持できなくなってしまいます。

![](https://storage.googleapis.com/zenn-user-upload/6692da1847ba-20250301.png =550x)

### 退行（regression）に対する保護を評価する要素

以下の 3 つの要素に注目しましょう：

1. **テスト時に実行されるプロダクション・コードの量**
   - テスト時に実行されるプロダクション・コードの量が増えるほど、退行を見つける可能性は高まる
   - ただし、前提として、**実行結果の適切な検証が行われていなければならない**
   - テスト対象のコードを単に実行しているだけでは不十分
   - 重要なのは、実行結果が期待通りの結果であることも確認すること
2. **そのコードの複雑さ**

   - 複雑なビジネスロジックが記述されたコードは、単純なコードよりも重要性が高い
   - 複雑なコードほどバグが入り込む余地が大きく、テストによる保護の価値が高まる
   - 単純なプロパティ定義のみのクラスなど「取るに足らないコード」のテスト価値は低い

     ```java
     public class User {
      public String name { get; set; }
     }
     ```

3. **そのコードが扱っているドメインの重要性**
   - ビジネス的に重要な機能になるほど、バグによる被害も大きくなる
   - 重要なドメインロジックに対するテストは、退行に対する保護として高い価値を持つ
   - アプリケーションのコードだけでなく、**使用しているライブラリやフレームワークなどの外部コードも考慮する必要がある**

:::message
**退行に対する保護を最大限備えるためには、テストの際にできるだけ多くのプロダクション・コードを実行させるようにします。**
:::

## ② リファクタリングへの耐性

これは、コードの動作を変えずに内部構造を改善する「**リファクタリング**」を行っても、テストが不必要に失敗しない性質を指します。

### 偽陽性（false positive）

リファクタリング中によく遭遇する問題が「**偽陽性（false positive）**」です。
これは、コードの機能自体は正しく動作しているにもかかわらず、テストが失敗してしまう現象です。

例えば、あなたが機能開発を完了し、すべてのテストが通った後、コードの可読性向上のためにリファクタリングを行ったとします。
コードの質は向上したものの、テストが突然失敗し始めました。
問題を調査しても、機能の振る舞いは意図通りで正常です。
このケースでは、テストが実装の詳細に依存しすぎており、コードの構造変更に対して脆弱だったと考えられます。

### 偽陽性がプロダクト開発に与える影響

偽陽性が頻発すると、以下のような流れで、プロジェクトに深刻な問題を引き起こします。

![](https://storage.googleapis.com/zenn-user-upload/5a9c1f077073-20250301.png =450x)

### 何が偽陽性を引き起こすのか？

### なぜリファクタリングへの耐性が重要か

単体テストの主目的は「プロジェクトの持続可能な成長を実現すること」です。
そのためには、以下が必要です。

- **バグの早期発見・修正を可能にする**
- **コード変更に自信を持って実施できる環境を作る**

しかし、偽陽性の多いテストはこれらのメリットを無効化します。
初期段階では開発者はテスト失敗に真剣に対応しますが、偽陽性に何度も悩まされると、次第にテスト結果を軽視するようになります。
最終的には、本当のバグによるテスト失敗さえも無視してしまい、問題を本番環境に持ち込むリスクが高まります。
